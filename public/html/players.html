<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Characters</title>
    <link rel="stylesheet" type="text/css" href="stylesheets/players_style.css">

    <script>
        let selected_char = "";
        let players_list = [];
        let players_name_list = [];

        function nextPlayer() {
            try {
                //Check if there is a char selected
                if (selected_char === '') {
                    alert('Please select a character!');
                    return;
                }
                //Check if name is already chosen
                let i = 0;
                let name = document.getElementById('new_player_name_textarea').value;

                for(i in players_name_list) {
                    console.log(i, name);
                    if (players_name_list[i] === name) {
                        alert('Please choose a different name');
                        document.getElementById('new_player_name_textarea').value = '';
                        return;
                    }

                }
                players_list.push('{"name":"' + name + '", "image":"' + getImage(selected_char) + '"}');
                players_name_list.push(name);
                console.log(players_list);

                //Clear fields and add a gray filter
                document.getElementById('new_player_name_textarea').value = '';
                document.getElementById(selected_char).style.filter = 'grayscale(0.9)';
                document.getElementById(selected_char).style.webkitFilter = 'grayscale(0.9)';
                document.getElementById(selected_char).style.background = "lightskyblue";
                document.getElementById(selected_char).onclick = '';

                //If max. 4 Players has been selected
                if (players_name_list.length === 4) {
                    document.getElementById('btn_start_game').style.background = "#f55";
                    document.getElementById('new_player_name_textarea').disabled = true;
                    document.getElementById('btn_next_player').disabled = true;
                }

                //Add player to interface
                var players_div = document.getElementById('created_players_div');
                players_div.style.visibility = 'visible';

                var div = document.createElement("div");


                let label = document.createElement("label");
                label.innerText = name;
                label.className = 'mini_player_name';

                let img = document.createElement('img');
                img.src = document.getElementById(selected_char).childNodes[1].src;
                img.className = 'mini_image';

                div.appendChild(label);
                div.appendChild(img);

                players_div.appendChild(div);

                selected_char = '';
            } catch (e) {
                console.log(e);
            }


        }

        function startGame() {

            if (players_list.length < 2) {
                alert('The game requires a minimum of two players');
                return;
            }

            let new_url = 'http://localhost:3000/game';
            let old_url = new URL(window.location.href);

            story_type = old_url.searchParams.get("type");
            const querystring = encodeQueryData(players_list);

            new_url = new_url + '?type=' + story_type + '&' + querystring;
            window.location.replace(new_url);
        }

        function selectImage(image, color) {
            document.getElementById('img_div_1').style.background = "lightskyblue";
            document.getElementById('img_div_2').style.background = "lightskyblue";
            document.getElementById('img_div_3').style.background = "lightskyblue";
            document.getElementById('img_div_4').style.background = "lightskyblue";
            document.getElementById(image.id).style.background = "#f00";
            document.getElementById(image.id).className = '';
            selected_char = image.id;

        }

        function encodeQueryData(data) {
            const ret = [];
            for (let d in data)
                ret.push(encodeURIComponent(d) + '=' + encodeURIComponent(data[d]));
            return ret.join('&');
        }

        function getImage(id) {
            switch (id) {
                case 'img_div_1': return 'red_left';
                case 'img_div_2': return 'blue_left';
                case 'img_div_3': return 'yellow_left';
                case 'img_div_4': return 'pink_left';
                default: return null;
            }
        }

    </script>
</head>
<body>

<div id="content">
    <div id="headline_div">
        <label id="players_headline">Spieler erstellen</label>
    </div>
    <div id="new_player_div">
        <p id="new_player_name_p">Name: </p>
        <textarea id="new_player_name_textarea"></textarea>
    </div>

    <div id="created_players_div">
        <!-- TODO: Format -->
    </div>

    <div id="new_char_div">
        <div class="icon" id="img_div_1" onclick="selectImage(this);">
            <img class="choose_players_char"src="./images/red_left.png">
        </div>
        <div class="icon" id="img_div_2" onclick="selectImage(this);">
            <img class="choose_players_char" src="./images/blue_left.png">
        </div>
        <div class="icon" id="img_div_3" onclick="selectImage(this);">
            <img class="choose_players_char" src="./images/yellow_left.png">
        </div>
        <div class="icon" id="img_div_4" onclick="selectImage(this);">
            <img class="choose_players_char" src="./images/pink_left.png">
        </div>

    </div>
    <div id="player_buttons">
        <button class="player_button" id="btn_next_player" onclick="nextPlayer()">NÃ¤chster Spieler</button>
        <button class="player_button" id="btn_start_game" onclick="startGame()">Zum Spiel</button>
    </div>

</div>
</body>
</html>