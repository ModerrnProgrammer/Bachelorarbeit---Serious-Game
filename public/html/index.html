<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="stylesheets/style.css">
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

</head>
<body>

    <div id="content">
        <span id="canvas_content_container"></span>
        <div id="cube_div">
            <h1 class="my_headline" id="cube_field_headline">WÃ¼rfel</h1>
            <div id="cube_numberfield_label">
                <label id="cube_numberfield">-1</label>
            </div>
            <button class="my_button" id="cube_roll_button" onclick="roll_the_dice()">START</button>
            <button class="my_button" id="cube_stop_button" onclick="stop_the_dice()">STOP</button>
            <button class="my_button" id="goal_button" onclick="toGoal()">ZIEL</button>

         </div>

        <div id="card_div">
            <div class="my_headline" id="card_headline">
                <h1>Cards</h1>
            </div>
            <div id="card_content">
                <div id="image_main_div">
                    <div id="image_div">
                        <img id="card_image" src="https://media.giphy.com/media/3ov9k1173PdfJWRsoE/giphy.gif" alt="Image">
                    </div>
                </div>
                <div id="card_image_overlay" hidden>
                    <label id="card_image_overlay_label" onclick="executeCardAction(currentActionCard);">Weiter</label>
                </div>
            </div>
            <div id="card_bottom">
                <label id="card_bottom_label">Start the game</label>
                <label id="card_text">Paste text here</label>
            </div>
        </div>

        <div id="current_player_div">
            <label id="current_player_name_label">Current player:</label>
        </div>
    </div>



    <script>
        var config = {
            type: Phaser.AUTO,
            width: 1200,
            height: 800,
            parent: 'canvas_content_container',
            title: 'MyGame',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 100 }
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        //Explosion GIF
        const EXPLOSION_GIF = 'https://media.giphy.com/media/bJaxgozZusl2g/giphy.gif';
        //Lamp GIF
        const LAMP_GIF = 'https://media.giphy.com/media/l1KVaST85EIicDiLe/giphy.gif';
        //Empty field GIF
        const EMPTY_FIELD_GIF = 'https://media.giphy.com/media/3ov9k1173PdfJWRsoE/giphy.gif';
        //Winner GIF
        const WINNER_GIF = 'https://media.giphy.com/media/2gtoSIzdrSMFO/giphy.gif';


        //var objects = {};
        let game = new Phaser.Game(config);


        //Current field position
       // let field_nr = 0;
        //All game field positions
        let gamefield_positions;
        //game field type list
        let gamefield_types;
        // List of all Knowledge Cards
        let knowledge_cards;
        // List of all Action cards - reality near story
        let action_cards_real;
        // List of all Action cards - fictitious story
        let action_cards_fictitious;
        // current card set length
        let card_set_length = 0;
        //public var for steps to go
        let steps = 0;
        //public print x and y values
        var_print_x = 250;
        var_print_y = 250;
        //game is busy like moving
        let ready = true;
        //game story type
        let story_type = '';


        //Constants
        const CARD_ID = 'card_image';
        const CARD_LABEL_ID = 'card_bottom_label';
        const CARD_TEXT_ID = 'card_text';

        const EMPTY_FIELD_TEXT = 'No card!';
        const LAMP_FIELD_TEXT = 'Knowledge Card!';
        const ACTION_FIELD_TEXT = 'Action Card!';
        const WINNER_FIELD_TEXT = 'YOU ARE THE WINNER';


        function preload () {
            try {

                //Load Characters
                this.load.image('pinki_left', './images/pink_left.png');
                this.load.image('pinki_right', './images/pink_right.png');
                this.load.image('red_left', './images/red_left.png');
                this.load.image('red_right', './images/red_right.png');
                this.load.image('blue_left', './images/blue_left.png');
                this.load.image('blue_right', './images/blue_right.png');
                this.load.image('yellow_left', './images/yellow_left.png');
                this.load.image('yellow_right', './images/yellow_right.png');

                //Load game fields
                this.load.image('explode', './images/explode.png');
                this.load.image('lamp', './images/lamp.png');
                this.load.image('start', './images/start_field.png');
                this.load.image('goal', './images/goal_field.png');
                this.load.image('empty', './images/empty_field.png');

                //Load params
                loadParameters();
            } catch (e) {
                alert('Cant load an image');
                console.log('ERROR on image loading');
            }
        }

        function create () {
            console.log('CREATE');
            this.cameras.main.backgroundColor.setTo(220,220,220);

            try {
                initFieldValues();
                initFieldTypes();
                initKnowledgeCards();
                initActionCardsReal();
                initActionCardsFictitious();

                generateGameBoard(this);
                drawCharacters(this);

                let player1 = this.add.sprite(400,400, 'pinki_left');
                let player2 = this.add.sprite(400,400, 'blue_left');
                createGameCharacters(player1, player2);
                nextPlayer();

            } catch (e) {
                console.error('Error while drawing', e);
            }
        }

        class Character {

            constructor(name, player, field_nr) {
                this.name = name;
                this.player = player;
                this.field_nr = field_nr;
            }

        }

        //Player variables
        let currentPlayer;
        let currentPlayerPos = -1;
        let character_1;
        let character_2;
        let character_3;
        let character_4;
        let playerList;
        //TODO: Dynamic?
        function createGameCharacters(player1, player2) {
            character_1 = new Character("Moritz", player1, 0);
            character_2 = new Character("AI", player2, 0);
            playerList = [character_1, character_2];
        }

        function nextPlayer() {
            //Random player starts the game
            if (currentPlayerPos === -1)
                currentPlayerPos = parseInt(Math.random() * playerList.length, 10);

            currentPlayerPos++;
            if (currentPlayerPos >= playerList.length) {
                currentPlayerPos = 0;
            }
            currentPlayer = playerList[currentPlayerPos];
            document.getElementById('current_player_name_label').innerText = 'Current player: ' + currentPlayer.name;

        }

        function drawCharacters(game) {
            /*
            //Pink
            objects.character_pink_left = game.add.image(50,50, 'pinki_left');
            objects.character_pink_right = game.add.image(100,50, 'pinki_right');
            //Red
            objects.character_red_left = game.add.image(150,50, 'red_left');
            objects.character_red_left = game.add.image(150,50, 'red_left');
            //Blue
            objects.character_blue_left = game.add.image(250,50, 'blue_left');
            objects.character_blue_right = game.add.image(300,50, 'blue_right');
            //Yellow
            objects.character_yellow_left = game.add.image(350,50, 'yellow_left');
            objects.character_yellow_right = game.add.image(400,50, 'yellow_right');
            */
            //player1 = game.add.sprite(400,400, 'pinki_left');


            game.add.image(50,50, 'pinki_left');
            game.add.image(100,50, 'pinki_right');
            game.add.image(150,50, 'red_left');
            game.add.image(200,50, 'red_right');
            game.add.image(250,50, 'blue_left');
            game.add.image(300,50, 'blue_right');
            game.add.image(350,50, 'yellow_left');
            game.add.image(400,50, 'yellow_right');
        }

        function print_start_fields(game) {
            const start_field_bias = 50;
            const x_bias_left = 35;

            game.add.image(400, 400, 'start');
            draw_line(game, 400, 400 - start_field_bias, 400, 250);
            game.add.image(400, 250, 'explode');
            draw_line(game, 400 - x_bias_left, 250, var_print_x, var_print_y);
            game.add.image(var_print_x, var_print_y, 'empty');
        }

        function print_common_fields(game) {
            print_field(game, 'below', 'lamp');
            print_field(game, 'below', 'explode');
            print_field(game, 'below', 'lamp');
            print_field(game, 'right', 'explode');
            print_field(game, 'right', 'lamp');
            print_field(game, 'right', 'empty');
            print_field(game, 'above', 'explode');
            print_field(game, 'above', 'lamp');
            print_field(game, 'above', 'explode');
            print_field(game, 'above', 'lamp');
            print_field(game, 'left', 'explode');
            print_field(game, 'left', 'empty');
            print_field(game, 'left', 'lamp');
            print_field(game, 'left', 'lamp');
            print_field(game, 'below', 'lamp');
            print_field(game, 'below', 'explode');
            print_field(game, 'below', 'lamp');
            print_field(game, 'below', 'empty');
            print_field(game, 'below', 'explode');
            print_field(game, 'right', 'lamp');
            print_field(game, 'right', 'explode');
            print_field(game, 'right', 'lamp');
            print_field(game, 'right', 'explode');
            print_field(game, 'right', 'empty');
            print_field(game, 'right', 'explode');
            print_field(game, 'above', 'lamp');
            print_field(game, 'above', 'explode');
            print_field(game, 'above', 'empty');
            print_field(game, 'above', 'lamp');
            print_field(game, 'above', 'explode');
            print_field(game, 'right', 'lamp');
            print_field(game, 'below', 'explode');
            print_field(game, 'below', 'lamp');
            print_field(game, 'below', 'lamp');
            print_field(game, 'below', 'empty');
            print_field(game, 'below', 'lamp');
            print_field(game, 'right', 'lamp');
            print_field(game, 'right', 'explode');
            print_field(game, 'above', 'explode');
            print_field(game, 'above', 'lamp');
            print_field(game, 'above', 'lamp');
        }

        function print_goal_field(game) {
            const y_bias_above = 35;
            const goal_pos_bias = 150;

            draw_line(game, var_print_x, var_print_y - y_bias_above, var_print_x, var_print_y - 100);
            game.add.image(var_print_x, var_print_y - goal_pos_bias, 'goal');
        }

        function generateGameBoard(game) {

            //Manual print first 3 fields
            print_start_fields(game);
            //Relational printing
            print_common_fields(game);
            //Manual print last field
            print_goal_field(game);

        }

        function initFieldValues() {
            gamefield_positions = JSON.parse('[{"pos_x":400,"pos_y":400},{"pos_x":400,"pos_y":250},' +
                '{"pos_x":250,"pos_y":250},{"pos_x":250,"pos_y":350},' +
                '{"pos_x":250,"pos_y":450},{"pos_x":250,"pos_y":550},{"pos_x":350,"pos_y":550},' +
                '{"pos_x":450,"pos_y":550},{"pos_x":550,"pos_y":550},{"pos_x":550,"pos_y":450},' +
                '{"pos_x":550,"pos_y":350},{"pos_x":550,"pos_y":250},{"pos_x":550,"pos_y":150},' +
                '{"pos_x":450,"pos_y":150},{"pos_x":350,"pos_y":150},{"pos_x":250,"pos_y":150},' +
                '{"pos_x":150,"pos_y":150},{"pos_x":150,"pos_y":250},{"pos_x":150,"pos_y":350},' +
                '{"pos_x":150,"pos_y":450},{"pos_x":150,"pos_y":550},{"pos_x":150,"pos_y":650},' +
                '{"pos_x":250,"pos_y":650},{"pos_x":350,"pos_y":650},{"pos_x":450,"pos_y":650},' +
                '{"pos_x":550,"pos_y":650},{"pos_x":650,"pos_y":650},{"pos_x":750,"pos_y":650},' +
                '{"pos_x":750,"pos_y":550},{"pos_x":750,"pos_y":450},{"pos_x":750,"pos_y":350},' +
                '{"pos_x":750,"pos_y":250},{"pos_x":750,"pos_y":150},{"pos_x":850,"pos_y":150},' +
                '{"pos_x":850,"pos_y":250},{"pos_x":850,"pos_y":350},{"pos_x":850,"pos_y":450},' +
                '{"pos_x":850,"pos_y":550},{"pos_x":850,"pos_y":650},{"pos_x":950,"pos_y":650},' +
                '{"pos_x":1050,"pos_y":650},{"pos_x":1050,"pos_y":550},{"pos_x":1050,"pos_y":450},' +
                '{"pos_x":1050,"pos_y":350}, {"pos_x":1050,"pos_y":200}]');

        }

        function initFieldTypes() {
            /*
             * -1: Start field
             *  0: Empty field
             *  1: Knowledge field (lamp, yellow)
             *  2: Action field (explosion, orange)
             *  3: Goal field
             */
            gamefield_types = [-1, 2, 0, 1, 2, 1, 2, 1, 0, 2, 1, 2, 1, 2, 0, 1, 1, 1, 2, 1, 0, 2, 1, 2, 1, 2, 0, 2,
                1, 2, 0, 1, 2, 1, 2, 1, 1, 0, 1, 1, 2, 2, 1, 1, 3];
        }

        function initKnowledgeCards() {
            knowledge_cards = [
                "Ziele des PrÃ¤sentierens sind Informieren und Ãberzeugen",
                "Informieren: dem EmpfÃ¤nger alle Informationen zur Hand geben, die er benÃ¶tigt, " +
                    "um nach der PrÃ¤sentation zur gewÃ¼nschten Art aktiv zu werden",
                "Titel von beruflichen PrÃ¤sentationen: dÃ¼rfen Aussagen enthalten",
                "Titel von allgemeinen PrÃ¤sentationen: sind meistens aneinander gereihte Stichworte",
                "Kommunikation ist die Ãbermittlung von Nachrichten vom Sender zum EmpfÃ¤nger.",
                "Ein mÃ¶glicher Kanal zur InformationsÃ¼bermittlung ist: akustisch (Stimme, Klang)",
                "Ein mÃ¶glicher Kanal zur InformationsÃ¼bermittlung ist: visuell (PPT, Mimik, Gestik)",
                "Ein mÃ¶glicher Kanal zur InformationsÃ¼bermittlung ist: taktil (BerÃ¼hrung, Demonstrationsobjekt)",
                "Wer eine PrÃ¤sentation hÃ¤lt, spricht den Sender Ã¼ber mehrere KanÃ¤le an.",
                "Ein mÃ¶glicher Kanal zur InformationsÃ¼bermittlung ist: olfaktorisch (Geruch, Geschmack)",
                "not to do: zu laut/leise reden",
                "not to do: zu Ã¼berladene PrÃ¤sentationen",
                "not to do: zu viele Folien",
                "to do: Raumgestaltung und -grÃ¶Ãe den Rahmenbedingungen anpassen",
                "Jede Nachricht hat vier Seiten: Sachinformation, Appell, Beziehungshinweis und Selbstkundgabe",
                "Prozess des PrÃ¤sentierens: Strukturieren Formulieren Visualisieren Editieren PrÃ¤sentieren",
                "Strukturieren: sowohl den Inhalt, als auch die Planung der PrÃ¤sentation",
                "Formulieren: logisch strukturierte Argumente zu einer Geschichte verknÃ¼pfen",
                "Visualisieren: Informationen in ein Bild Ã¼bersetzen",
                "Editieren: die PrÃ¤sentation proben",
                "PrÃ¤sentieren: der eigentliche Auftritt vor Publikum",
                "Bevor man mit einer PrÃ¤sentation startet, sollte das Ziel der PrÃ¤sentation klar sein",
                "1.\tDas Ziel der PrÃ¤sentation kann mit folgenden Fragen geklÃ¤rt werden:  Was sollen die Teilnehmer " +
                    "nach der PrÃ¤sentation vom Thema wissen? Was sollen sie vom Thema halten? Was sollen sie tun?",
                "PrÃ¤sentationen dÃ¼rfen unterhaltsam sein. Dabei helfen Bilder und Anekdoten.",
                "Der Nutzen steht  vor der Unterhaltung.",
                "Erfolgreiche PrÃ¤sentationen leben von der Interaktion mit dem Publikum.",
                "Zwei bis drei Minuten pro Folie reden.",
                "PrÃ¤sentationsmedium: Flipchart",
                "PrÃ¤sentationsmedium: Beamer-PrÃ¤sentation",
                "â¢\tVorteile Beamer-PrÃ¤sentation:  keine Folien ausdrucken Ãnderungen und Korrekturen\n" +
                    "sind bis zur letzten Minute mÃ¶glich Einbindung von Musik und Video mÃ¶glich.",
                "Nachteile Beamer-PrÃ¤sentation:  Technikprobleme nicht spontan",
                "PrÃ¤sentationsmedium: Overhead-Projektor",
                "PrÃ¤sentationsmedium: Pinnwand",
                "Vorteil Pinnwand: Gut, wenn in Interaktion mit dem Publikum etwas erarbeitet werden soll.",
                "PrÃ¤sentationsmedium: Tafel/Whiteboard",
                "Nachteile Tafel/Whiteboard:  unleserliche Schrift zeitgleich reden und schreiben Blickkontakt halten" +
                    " beim Schreiben schwierig",
                "Wovon hÃ¤ngt die Medienwahl ab?  Thema Raum Teilnehmer Medien PrÃ¤sentierender Unterlagen"
            ];
        }
        
        function initActionCardsReal() {
            action_cards_real = JSON.parse('[' +
                '{"text": "Du hast vergessen die Gliederung deiner Abschluss- prÃ¤sentation rechtzeitig abzugeben.' +
                ' Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -2, "card": 1},' +
                '{"text":"Du hast frÃ¼h genug angefangen dir Gedanken Ã¼ber den Aufbau deiner AbschlussprÃ¤sentation ' +
                'zu machen.' +
                ' Gehe drei Schritte vor.",' +
                ' "action": 3, "card": 0},' +
                '{"text":"Du probst deine AbschlussprÃ¤sentation nicht.' +
                ' Gehe einen Schritt zurÃ¼ck ' +
                'und ziehe eine Wissenskarte.", ' +
                '"action": -1, "card": 1},' +
                '{"text":"Du bist dir nicht ganz sicher, ob der rote Faden in deiner PrÃ¤sentation zu erkennen ist.' +
                ' Deshalb hÃ¤ltst du die PrÃ¤sentation vor ein paar Freunden.' +
                ' Gehe zwei Schritte vor.",' +
                ' "action": 2, "card": 0},' +
                '{"text":"Mit deiner AbschlussprÃ¤sentation fÃ¤ngst du erst am Abend vor dem Termin an. ' +
                'Gehe drei Schritte zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -3, "card": 1},' +
                '{"text":"Du hast frÃ¼h genug damit angefangen fÃ¼r die Klausuren zu lernen.' +
                ' Gehe drei Schritte vor.",' +
                ' "action": 3, "card": 0},' +
                '{"text":"Du hast erst am Abend vor der Klausur angefangen zu lernen. ' +
                'Gehe drei Schritte zurÃ¼ck und ziehe eine Wissenskarte.", "action": -3, "card": 1},' +
                '{"text":"Du hast vergessen dich zu einer Klausur anzumelden.' +
                ' Gehe zurÃ¼ck zum Start und ziehe eine Wissenskarte.",' +
                ' "action": -100, "card": 1},' +
                '{"text":"Du verbringst den Vormittag lieber mit Lernen statt mit Ausschlafen. ' +
                'Gehe zwei Schritte vor.",' +
                ' "action": 2, "card": 0},' +
                '{"text":"Du schlÃ¤fst lieber aus, anstelle zu lernen. ' +
                'Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -2, "card": 1},' +
                '{"text":"Du vergisst deine Lernsachen in der Bib. ' +
                'Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -1, "card": 1},' +
                '{"text":"Du suchst dir rechtzeitig eine Lerngruppe, die du alle zwei Tage triffst. ' +
                'Gehe drei Schritte vor.",' +
                ' "action": 3, "card": 0},' +
                '{"text":"Deine Karteikarten sind drei Wochen vor der Klausur fertig.' +
                ' Gehe einen Schritt vor",' +
                ' "action": 1, "card": 0},' +
                '{"text":"Du planst lieber die Party nach deiner AbschlussprÃ¤sentation statt' +
                ' fÃ¼r die AbschussprÃ¤sentation vorzubereiten.' +
                ' Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -2, "card": 1},' +
                '{"text":"Du hast wÃ¤hrend der Vorlesungszeit immer alle ÃbungsblÃ¤tter behandelt.' +
                ' Gehe zwei Schritte vor.",' +
                ' "action": 2, "card": 0},' +
                '{"text":"Bei den Proben deiner PrÃ¤sentation wirst du immer besser und besser.' +
                ' Gehe einen Schritt vor.",' +
                ' "action": 1, "card": 0},' +
                '{"text":"Du bist davon Ã¼berzeugt, dass du deine PrÃ¤sentation vorher nicht proben musst.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.", ' +
                '"action": -1, "card": 1},' +
                '{"text":"Leider hast du bei der Eingrenzung fÃ¼r die Klausur nicht aufgepasst. Dadurch hast du die' +
                ' falschen Inhalte gelernt.' +
                ' Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -2, "card": 1},' +
                '{"text":"Du hast passende Bilder in deine AbschlussprÃ¤sentation eingebaut.' +
                ' Gehe einen Schritt vor.",' +
                ' "action": 1, "card": 0},' +
                '{"text":"Du machst dir Gedanken Ã¼ber die Anzahl der Folien in deiner SeminarprÃ¤sentation.' +
                ' Gehe einen Schritt vor.",' +
                ' "action": 1, "card": 0},' +
                '{"text":"Du fÃ¼gst ganz willkÃ¼rlich Folien in deine AbschlussprÃ¤sentation ein und ' +
                'zeigst einige der Folien nur wenige Sekunden lang.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -1, "card": 1},' +
                '{"text":"Du machst eine Pause und gehst eine Runde joggen.' +
                ' Gehe einen Schritt vor.",' +
                ' "action": 1, "card": 0},' +
                '{"text":"Du machst eine Pause und zockst drei Stunden lang Computerspiele.' +
                ' Danach lohnt sich das Lernen auch nicht mehr.' +
                ' Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -2, "card": 1},' +
                '{"text":"Deine AbschlussprÃ¤sentation ist eine Woche vorher fertig.' +
                ' Du hast genug Zeit sie Korrekturlesen zu lassen.' +
                ' Gehe einen Schritt vor.", "action": 1, "card": 0},' +
                '{"text":"Du kommst ausgeschlafen und ausgeruht zur AbschlussprÃ¤sentation. ' +
                'Gehe einen Schritt vor.", "action": 1, "card": 0},' +
                '{"text":"Am Abend vor der AbschlussprÃ¤sentation gehst du in die ' +
                'Mitternachtspremiere des neuen Star Wars Films. ' +
                'Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -1, "card": 1}' +
                ']');
        }

        function initActionCardsFictitious() {
            action_cards_fictitious = JSON.parse('[' +
                '{"text":"Die restlichen Badanklas lachen dich hinter deinem RÃ¼cken fÃ¼r deine PrÃ¤sentationen aus.' +
                ' Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte",' +
                ' "action": -2, "card": 1},' +
                '{"text":"Die PrÃ¤sentation lÃ¤sst du von deinem Badankla-Azubi erstellen und probst sie vorher nicht.' +
                ' Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -2, "card": 1},' +
                '{"text":"Du engagierst einen Privatlehrer, der mit dir das PrÃ¤sentieren Ã¼bt. ' +
                'Gehe drei Schritte vor.", ' +
                '"action": 3, "card": 0},' +
                '{"text":"Bei einem wichtigen Fernsehauftritt, wo Ã¶ffentlich eure Ideen vorgestellt werden,' +
                ' kannst du das Ziel deiner PrÃ¤sentation nicht klar darstellen. Die Zuschauer sind verwirrt.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.", "action": -1, "card": 1},' +
                '{"text":"Der rote Faden ist in deiner PrÃ¤sentation nicht erkennbar. ' +
                'Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -1, "card": 1},' +
                '{"text":"Dem Rat der groÃen Bedinklos wird nicht klar, warum du die MÃ¼nzen benÃ¶tigst.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.", "action": -1, "card": 1},' +
                '{"text":"Du probst die PrÃ¤sentation vor deinen Badankla-Freunden und ' +
                'nimmst VerbesserungsvorschlÃ¤ge entgegen.' +
                ' Gehe zwei Schritte vor.",' +
                ' "action": 2, "card": 0},' +
                '{"text":"Du untermauerst deine Argumente mit aussagekrÃ¤ftigen Bildern.' +
                ' Gehe einen Schritt vor.",' +
                ' "action": 1, "card": 0},' +
                '{"text":"Du gehst im Vorfeld schon mÃ¶gliche Fragen des Rats der groÃen Bedinklos durch, ' +
                'damit du besser darauf vorbereitet bist. Gehe zwei Schritte vor.",' +
                ' "action": 2, "card": 0},' +
                '{"text":"Weil du die PrÃ¤sentation so lange vor der hergeschoben hast,' +
                ' hast du jetzt keine Zeit mehr mit aktuellen Zahlen zu arbeiten. ' +
                'Stattdessen musst du veraltete Werte zur Lage aus Bidinkli verwenden. ' +
                'Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -2, "card": 1},' +
                '{"text":"Die VerbesserungsvorschlÃ¤ge deiner Badankla-Freunde akzeptierst du nicht.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -1, "card": 1},' +
                '{"text":"Du wÃ¤hlst das Flipchart als PrÃ¤sentationsmedium. ' +
                'Leider hast du vergessen, dass in dem Raum 150 Teilnehmer sitzen. Nur die Teilnehmer ' +
                'aus den vorderen Reihen kÃ¶nnen erahnen, was auf dem Flipchart steht.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.", "action": -1, "card": 1},' +
                '{"text":"Statt deine PrÃ¤sentation zu Ã¼ben, gehst du lieber mit einem GeschÃ¤ftsmann-Badankla essen.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.", "action": -1, "card": 1},' +
                '{"text":"Statt deine PrÃ¤sentation zu Ã¼ben, Ã¼berlegst du dir schon jetzt,' +
                ' wie du die positive Nachricht den Badanklas mitteilen wirst, ' +
                'damit deine Wahl in den Rat der groÃen Bedinklos gesichert ist. ' +
                'Gehe zwei Schritte zurÃ¼ck und ziehe eine Wissenskarte.", "action": -2, "card": 1},' +
                '{"text":"Die Argumente deiner PrÃ¤sentation bauen aufeinander auf und sind schlÃ¼ssig. ' +
                'Gehe zwei Schritte vor.",' +
                ' "action": 2, "card": 0},' +
                '{"text":"Weil du dich siegessicher fÃ¼hlst, probst du deine PrÃ¤sentation nicht. ' +
                'Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.", "action": -1, "card": 1},' +
                '{"text":"Du glaubst nicht daran, dass du mit einer guten PrÃ¤sentation die MÃ¼nzen tatsÃ¤chlich bekommen' +
                ' kÃ¶nntest, daher gibst du dir auch keine MÃ¼he.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -1, "card": 1},' +
                '{"text":"Du hast gehÃ¶rt, dass sich die anderen Badanklas seit Wochen auf ' +
                'ihre PrÃ¤sentation vorbereiten. Du selbst hast immer noch nicht angefangen,' +
                ' obwohl es in zwei Tagen soweit ist.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.", "action": -1, "card": 1},' +
                '{"text":"Deine Badankla-Freunde sagen zu dir, dass du immer besser und besser prÃ¤sentierst.' +
                ' Gehe zwei Schritte vor.",' +
                ' "action": 2, "card": 0},' +
                '{"text":"Du bist Ã¼berzeugt davon, dass du mit einer guten PrÃ¤sentation ' +
                'die wichtigen MÃ¼nzen bekommen wirst. Deshalb gibst du dir sehr viel MÃ¼he.' +
                ' Gehe einen Schritt vor.", "action": 1, "card": 0},' +
                '{"text":"Du weiÃt, dass du einen Presenter benÃ¶tigst, vergisst ihn aber.' +
                ' Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.",' +
                ' "action": -1, "card": 1},' +
                '{"text":"In deiner Recherche prÃ¼fst du, welche Badanklas in den vorherigen Jahren MÃ¼nzgelder ' +
                'bekommen haben und warum.' +
                ' Gehe einen Schritt vor.",' +
                ' "action": 1, "card": 0},' +
                '{"text":"Je Ã¶fter du deine PrÃ¤sentation Ã¼bst, desto besser und selbstsicherer wirst du.' +
                ' Gehe einen Schritt vor.", "action": 1, "card": 0},' +
                '{"text":"Du hast Bilder in deiner PrÃ¤sentation, die thematisch nicht passen. ' +
                'Gehe einen Schritt zurÃ¼ck und ziehe eine Wissenskarte.", "action": -1, "card": 1},' +
                '{"text":"Du hast versehentlich deine PrÃ¤sentation gelÃ¶scht und hattest sie nicht woanders gespeichert.' +
                ' Gehe zurÃ¼ck zum Start.",' +
                ' "action": -100, "card": 0}' +
                ']');
        }
        
        /** Draw an image related to last printed image position
         *
         * @param game Game to print on
         * @param mode Direction of line and related new position direction
         * @param image Image to print
         */
        function print_field(game, mode, image) {
            let old_x = var_print_x;
            let old_y = var_print_y;

            const y_bias_below = 32;
            const y_bias_above = 35;
            const x_bias_left = 35;
            const x_bias_right = 33;
            const circle_distance = 100;

            switch (mode) {
                case 'below':
                    var_print_y += circle_distance;
                    old_y += y_bias_below;
                    break;
                case 'above':
                    var_print_y -= circle_distance;
                    old_y -= y_bias_above;
                    break;
                case 'left':
                    var_print_x -= circle_distance;
                    old_x -= x_bias_left;
                    break;
                case 'right':
                    var_print_x += circle_distance;
                    old_x += x_bias_right;
                    break;
                default:
                    break;
            }
            draw_line(game, old_x, old_y, var_print_x, var_print_y);
            game.add.image(var_print_x, var_print_y, image);
        }

        /** Drawing a line from point A to point B
         *
         * @param game Game to print on
         * @param x1 1st point x position
         * @param y1 1st point y position
         * @param x2 2nd point x position
         * @param y2 2nd point y position
         */
        function draw_line(game, x1, y1, x2, y2) {
            let bias = 3;
            var graphics = game.add.graphics({ lineStyle: { width: 2, color: 0x000000 } });
            var line = new Phaser.Geom.Line(x1 - bias, y1, x2 - bias , y2);
            graphics.strokeLineShape(line);
        }

        let roll = false;
        async function  roll_the_dice() {
            if (!ready || roll || waitForAction)  return;
            let number = 0;
            document.getElementById('cube_numberfield').innerText = number;
            roll = true;
            while (roll) {
                number += 1;
                if (number === 7) {
                    number = 1;
                }
                document.getElementById('cube_numberfield').innerText = number;
                await Sleep(25);

            }
        }

        function  stop_the_dice() {
            if (roll || waitForAction) {
                roll = false;
                steps = parseInt(document.getElementById('cube_numberfield').innerText);
                currentPlayer.field_nr += 1;
            }
        }

        let stop_value_x;
        let stop_value_y;

        function update() {

            if (steps !== 0) {
                move();
            }
        }

        //TODO: No overlapping
        let waitForAction = false;
        function move() {
            //console.log('move');
            if (waitForAction) return;
            //console.log('steps: ' + steps);
            //console.log('FNR: ' + currentPlayer.field_nr);
            ready = false;


            //Start field pos check
            if (currentPlayer.field_nr < 0) {
                currentPlayer.field_nr = 0;
            }

            if (currentPlayer.field_nr + steps > gamefield_types.length) {
                ready = true;
                return;
            }



            let pos_tuppel = calculateNewField(currentPlayer.field_nr);
            stop_value_x = pos_tuppel.pos_x;
            stop_value_y = pos_tuppel.pos_y;
            const SPEED = 10;



            //TODO: Change to current player
            let direction = calculateDirection(currentPlayer.player.x, currentPlayer.player.y, stop_value_x, stop_value_y);

            switch (direction) {
                case 'up':
                    if (currentPlayer.player.y !== stop_value_y) {
                        currentPlayer.player.y -= SPEED;
                        checkLastMove(currentPlayer.player.y, stop_value_y);
                    }
                    break;
                case 'down':
                    if (currentPlayer.player.y !== stop_value_y) {
                        currentPlayer.player.y += SPEED;
                        checkLastMove(currentPlayer.player.y, stop_value_y);
                    }
                    break;
                case 'left':
                    if (currentPlayer.player.x !== stop_value_x) {
                        currentPlayer.player.x -= SPEED;
                        checkLastMove(currentPlayer.player.x, stop_value_x);
                    }
                    break;
                case 'right':
                    if (currentPlayer.player.x !== stop_value_x) {
                        currentPlayer.player.x += SPEED;
                        checkLastMove(currentPlayer.player.x, stop_value_x);
                    }
                    break;
                default:
                    break;
            }
        }

        function checkLastMove(value1, value2) {
            //if last move
            if (value1 === value2) {
                if (currentPlayer.field_nr === 0) {
                    steps = 0;
                }
                //Reset Shift variables
                active_x_shift = false;
                active_y_shift = false;

                // Are steps left?
                if (steps > 0) {
                    steps--;
                    if (steps > 0) currentPlayer.field_nr++;
                } else if (steps < 0) {
                    steps++;
                    if (steps < 0) currentPlayer.field_nr--;
                }
                if (steps === 0) {
                    checkWin();
                    setImageAndText();
                    if (!waitForAction) {
                        nextPlayer();
                    }
                    ready = true;
                }

            }
        }

        //TODO: Game end when there is just one player
        function checkWin() {
            if (gamefield_types[currentPlayer.field_nr] === 3) {

                //Remove player from Player Pool
                for (let i = 0; i < playerList.length; i++) {
                    if (currentPlayer === playerList[i]) {
                        playerList.splice(i, 1);
                    }
                }
                console.log('Test remove player on win:', playerList);
            }
        }

        let currentActionCard;

        async function setImageAndText() {


            let type = gamefield_types[currentPlayer.field_nr];
            switch (type) {
                case -1:
                    break;
                case 0:
                    //Ignore action when reaching field with card action
                    if (ignoreAction) {
                        ignoreAction = false;
                        break;
                    }

                    // Reset card and text
                    document.getElementById(CARD_ID).src = EMPTY_FIELD_GIF;
                    document.getElementById(CARD_LABEL_ID).innerText = EMPTY_FIELD_TEXT;
                    document.getElementById(CARD_TEXT_ID).innerText = '';
                    break;
                case 1:
                    //Ignore action when reaching field with card action
                    if (ignoreAction) {
                        ignoreAction = false;
                        break;
                    }

                    // Set card and text to knowledge theme
                    // Choose random knowledge phrase
                    document.getElementById(CARD_ID).src = LAMP_GIF;
                    document.getElementById(CARD_LABEL_ID).innerText = LAMP_FIELD_TEXT;
                    document.getElementById(CARD_TEXT_ID).innerText = getKnowledgeText();

                    break;
                case 2:
                    //Ignore action when reaching field with card action
                    if (ignoreAction) {
                        ignoreAction = false;
                        break;
                    }
                    document.getElementById(CARD_ID).src = EXPLOSION_GIF;
                    document.getElementById(CARD_LABEL_ID).innerText = ACTION_FIELD_TEXT;
                    let action_card = getActionText();
                    document.getElementById(CARD_TEXT_ID).innerText = action_card.text;


                    //TODO: IDee: Alle Buttons ausblenden. FlÃ¤che Ã¼ber dem Bild einblenden mit dem Titel Klick oder so
                    //Auf dem Klick Zug ausfÃ¼hren
                    document.getElementById('card_image_overlay').hidden = false;
                    document.getElementById('image_div').style.zIndex = "3";
                    document.getElementById('image_div').style.opacity = "0.5";

                    waitForAction = true;
                    currentActionCard = action_card;

                    break;
                case 3:
                    document.getElementById(CARD_ID).src = WINNER_GIF;
                    document.getElementById(CARD_LABEL_ID).innerText = WINNER_FIELD_TEXT;
                    document.getElementById(CARD_TEXT_ID).innerText = '';

                    break;
                default:
                    break;
            }
        }

        function getKnowledgeText() {
            let random_nr = Math.floor(Math.random() * knowledge_cards.length);
            return knowledge_cards[random_nr];
        }



        function getActionText() {
            let text;
            if (story_type === 'real') {
                let random_nr = Math.floor(Math.random() * action_cards_real.length);
                text = action_cards_real[random_nr];
            } else {
                //Story is fictitious
                let random_nr = Math.floor(Math.random() * action_cards_fictitious.length);
                text = action_cards_fictitious[random_nr];
            }
            return text
        }

        function calculateNewField(nr) {
            return gamefield_positions[nr];
        }

        //Vars to execute a full move and then reevaluate the direction of the movement
        let active_y_shift = false;
        let active_x_shift = false;
        function calculateDirection(pos_x, pos_y, stop_value_x, stop_value_y) {
            let diff_x = Math.abs(pos_x - stop_value_x);
            let diff_y = Math.abs(pos_y - stop_value_y);

            if (active_y_shift) return check_Y_Shift(pos_y, stop_value_y);
            if (active_x_shift) return check_X_Shift(pos_x, stop_value_x);

            if (diff_x >= diff_y) {
                active_x_shift = true;
                return check_X_Shift(pos_x, stop_value_x);
            } else if (diff_x < diff_y) {
                active_y_shift = true;
                return check_Y_Shift(pos_y, stop_value_y);

            }
            return 'no action';
        }

        function check_X_Shift(pos_x, stop_value_x) {
            if (pos_x > stop_value_x) {
                return 'left';
            } else if (pos_x < stop_value_x) {
                return 'right';
            }

            return 'no action';
        }

        function check_Y_Shift(pos_y, stop_value_y) {
            if (pos_y > stop_value_y) {
                return 'up';
            } else if (pos_y < stop_value_y) {
                return 'down';
            }

            return 'no action';
        }

        function Sleep(milliseconds) {
            return new Promise(resolve => setTimeout(resolve, milliseconds));
        }



        //Var that the fields action of the next move is ignored
        let ignoreAction = false;
        function executeCardAction(action_card) {
            steps = action_card.action;


            //Go forward card
            if (steps > 0) currentPlayer.field_nr++;
            //Go back card
            if (steps < 0) currentPlayer.field_nr--;

            //New science card
            if (action_card.card === 1) {
                document.getElementById(CARD_TEXT_ID).innerText = getKnowledgeText();
                document.getElementById(CARD_ID).src = LAMP_GIF;
            }

            ignoreAction = true;
            waitForAction= false;

            document.getElementById('card_image_overlay').hidden = true;
            document.getElementById('image_div').style.zIndex = "5";
            document.getElementById('image_div').style.opacity = "1";
        }

        function toGoal() {
            steps = +39;
            currentPlayer.field_nr++;
        }

        function loadParameters() {
            let url = new URL(window.location.href);
            story_type = url.searchParams.get("type");
        }
    </script>

</body>
</html>